<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Database</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
    }
    button:hover {
      background: #059669;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üç∞ Setup Cake Shop Database</h1>
    <p>This will create all necessary tables in your Supabase database for the orders system.</p>
    <button id="setupBtn" onclick="setupDatabase()">Setup Database</button>
    <div id="log"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kftgoeeqjbxflktgkgdy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmdGdvZWVxamJ4ZmxrdGdrZ2R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjY3ODYsImV4cCI6MjA3Mzk0Mjc4Nn0.PyFtzBO4WQzLXv_RjpF_gq5fUpzpFDFgrepNQodPUHo';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const line = document.createElement('div');
      line.className = type;
      line.textContent = message;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function setupDatabase() {
      const btn = document.getElementById('setupBtn');
      btn.disabled = true;
      document.getElementById('log').innerHTML = '';

      log('Starting database setup...', 'info');

      const statements = [
        // Create update function
        `CREATE OR REPLACE FUNCTION update_updated_at_column()
        RETURNS TRIGGER AS $$
        BEGIN
          NEW.updated_at = now();
          RETURN NEW;
        END;
        $$ LANGUAGE plpgsql`,

        // Categories
        `CREATE TABLE IF NOT EXISTS public.categories (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          name TEXT NOT NULL UNIQUE,
          description TEXT,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Products
        `CREATE TABLE IF NOT EXISTS public.products (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          category_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,
          name TEXT NOT NULL,
          description TEXT,
          base_price DECIMAL(10, 2) NOT NULL,
          image_url TEXT,
          is_featured BOOLEAN NOT NULL DEFAULT false,
          is_active BOOLEAN NOT NULL DEFAULT true,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
          updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Product sizes
        `CREATE TABLE IF NOT EXISTS public.product_sizes (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
          size_name TEXT NOT NULL,
          weight TEXT,
          price_multiplier DECIMAL(5, 2) NOT NULL DEFAULT 1.0,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Addons
        `CREATE TABLE IF NOT EXISTS public.addons (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          name TEXT NOT NULL,
          description TEXT,
          price DECIMAL(10, 2) NOT NULL,
          type TEXT NOT NULL,
          is_active BOOLEAN NOT NULL DEFAULT true,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Customers
        `CREATE TABLE IF NOT EXISTS public.customers (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          name TEXT NOT NULL,
          phone TEXT NOT NULL UNIQUE,
          email TEXT,
          address TEXT,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
          updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Orders
        `CREATE TABLE IF NOT EXISTS public.orders (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
          customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,
          customer_name TEXT NOT NULL,
          customer_phone TEXT NOT NULL,
          customer_email TEXT,
          delivery_address TEXT NOT NULL,
          delivery_date DATE NOT NULL,
          delivery_time TEXT NOT NULL,
          special_instructions TEXT,
          total_amount DECIMAL(10, 2) NOT NULL,
          payment_method TEXT NOT NULL DEFAULT 'cod',
          payment_status TEXT NOT NULL DEFAULT 'pending',
          status TEXT NOT NULL DEFAULT 'pending',
          delivery_name TEXT,
          delivery_phone TEXT,
          order_notes TEXT,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
          updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Order items
        `CREATE TABLE IF NOT EXISTS public.order_items (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
          product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE RESTRICT,
          quantity INTEGER NOT NULL DEFAULT 1,
          unit_price DECIMAL(10, 2) NOT NULL,
          custom_message TEXT,
          customizations JSONB,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Order addons
        `CREATE TABLE IF NOT EXISTS public.order_addons (
          id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
          order_item_id UUID NOT NULL REFERENCES public.order_items(id) ON DELETE CASCADE,
          addon_id UUID NOT NULL REFERENCES public.addons(id) ON DELETE RESTRICT,
          quantity INTEGER NOT NULL DEFAULT 1,
          unit_price DECIMAL(10, 2) NOT NULL,
          created_at TIMESTAMPTZ NOT NULL DEFAULT now()
        )`,

        // Enable RLS
        `ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.products ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.product_sizes ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.addons ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.customers ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.order_items ENABLE ROW LEVEL SECURITY`,
        `ALTER TABLE public.order_addons ENABLE ROW LEVEL SECURITY`,

        // RLS Policies
        `DROP POLICY IF EXISTS "Categories are viewable by everyone" ON public.categories`,
        `CREATE POLICY "Categories are viewable by everyone" ON public.categories FOR SELECT USING (true)`,

        `DROP POLICY IF EXISTS "Active products are viewable by everyone" ON public.products`,
        `CREATE POLICY "Active products are viewable by everyone" ON public.products FOR SELECT USING (is_active = true)`,

        `DROP POLICY IF EXISTS "Product sizes are viewable by everyone" ON public.product_sizes`,
        `CREATE POLICY "Product sizes are viewable by everyone" ON public.product_sizes FOR SELECT USING (true)`,

        `DROP POLICY IF EXISTS "Active addons are viewable by everyone" ON public.addons`,
        `CREATE POLICY "Active addons are viewable by everyone" ON public.addons FOR SELECT USING (is_active = true)`,

        `DROP POLICY IF EXISTS "Anyone can create customer records" ON public.customers`,
        `CREATE POLICY "Anyone can create customer records" ON public.customers FOR INSERT WITH CHECK (true)`,

        `DROP POLICY IF EXISTS "Users can view their own orders" ON public.orders`,
        `CREATE POLICY "Users can view their own orders" ON public.orders FOR SELECT TO authenticated USING (auth.uid() = user_id)`,

        `DROP POLICY IF EXISTS "Users can create orders" ON public.orders`,
        `CREATE POLICY "Users can create orders" ON public.orders FOR INSERT TO authenticated WITH CHECK (auth.uid() = user_id OR user_id IS NULL)`,

        `DROP POLICY IF EXISTS "Users can view order items for their orders" ON public.order_items`,
        `CREATE POLICY "Users can view order items for their orders" ON public.order_items FOR SELECT TO authenticated USING (order_id IN (SELECT id FROM public.orders WHERE user_id = auth.uid()))`,

        `DROP POLICY IF EXISTS "Users can create order items for their orders" ON public.order_items`,
        `CREATE POLICY "Users can create order items for their orders" ON public.order_items FOR INSERT TO authenticated WITH CHECK (order_id IN (SELECT id FROM public.orders WHERE user_id = auth.uid()))`
      ];

      let successCount = 0;
      let errorCount = 0;

      for (let i = 0; i < statements.length; i++) {
        try {
          log(`[${i + 1}/${statements.length}] Executing...`, 'info');

          const { data, error } = await supabase.rpc('exec_sql', {
            query: statements[i]
          });

          if (error) {
            log(`‚úó Error: ${error.message}`, 'error');
            errorCount++;
          } else {
            log(`‚úì Success`, 'success');
            successCount++;
          }
        } catch (err) {
          log(`‚úó Exception: ${err.message}`, 'error');
          errorCount++;
        }
      }

      log(`\n=== Summary ===`, 'info');
      log(`‚úì Successful: ${successCount}`, 'success');
      log(`‚úó Errors: ${errorCount}`, errorCount > 0 ? 'error' : 'info');

      if (errorCount === 0) {
        log('\nüéâ Database setup completed successfully!', 'success');
      } else {
        log('\n‚ö†Ô∏è  Some statements failed. This is normal if tables already exist.', 'info');
      }

      btn.disabled = false;
    }
  </script>
</body>
</html>
